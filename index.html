// ==================== ç³»çµ±è¨­å®š ====================
const CONFIG = {
  SHEET_NAME: "AINews",
  SPREADSHEET_NAME: "å…¨çƒAIç§‘æŠ€æ–°èç³»çµ±",
  
  // 22å€‹æ–°èæºï¼ˆ12åœ‹éš› + 3å°ç£ + 7ç§‘æŠ€å°ˆå±¬ï¼‰
  RSS_SOURCES: [
    // ========== åœ‹éš›ä¸»æµæ–°è (12å€‹) ==========
    { 
      url: "https://feeds.bbci.co.uk/news/technology/rss.xml", 
      name: "BBC Technology",
      country: "UK",
      type: "åœ‹éš›",
      language: "en",
      priority: 1
    },
    { 
      url: "http://rss.cnn.com/rss/edition_technology.rss", 
      name: "CNN Technology",
      country: "US",
      type: "åœ‹éš›",
      language: "en",
      priority: 1
    },
    { 
      url: "https://feeds.reuters.com/reuters/technologyNews", 
      name: "Reuters Technology",
      country: "International",
      type: "åœ‹éš›",
      language: "en",
      priority: 1
    },
    { 
      url: "https://apnews.com/apf-technology.rss", 
      name: "AP Technology",
      country: "US",
      type: "åœ‹éš›",
      language: "en",
      priority: 1
    },
    { 
      url: "https://www.bloomberg.com/technology.rss", 
      name: "Bloomberg Tech",
      country: "US",
      type: "åœ‹éš›",
      language: "en",
      priority: 1
    },
    { 
      url: "https://www.ft.com/technology?format=rss", 
      name: "Financial Times Tech",
      country: "UK",
      type: "åœ‹éš›",
      language: "en",
      priority: 1
    },
    { 
      url: "https://www.wsj.com/news/technology?mod=rss", 
      name: "WSJ Technology",
      country: "US",
      type: "åœ‹éš›",
      language: "en",
      priority: 1
    },
    { 
      url: "https://rss.nytimes.com/services/xml/rss/nyt/Technology.xml", 
      name: "NY Times Tech",
      country: "US",
      type: "åœ‹éš›",
      language: "en",
      priority: 1
    },
    { 
      url: "https://www.theguardian.com/technology/rss", 
      name: "Guardian Technology",
      country: "UK",
      type: "åœ‹éš›",
      language: "en",
      priority: 1
    },
    { 
      url: "https://www.economist.com/technology-quarterly/rss.xml", 
      name: "Economist Tech",
      country: "UK",
      type: "åœ‹éš›",
      language: "en",
      priority: 1
    },
    { 
      url: "https://www.wired.com/feed/rss", 
      name: "Wired Technology",
      country: "US",
      type: "åœ‹éš›",
      language: "en",
      priority: 1
    },
    { 
      url: "https://techcrunch.com/feed/", 
      name: "TechCrunch",
      country: "US",
      type: "åœ‹éš›",
      language: "en",
      priority: 1
    },
    
    // ========== AIå°ˆå±¬æ–°èæº (7å€‹) ==========
    { 
      url: "https://openai.com/blog/rss/", 
      name: "OpenAI Blog",
      country: "US",
      type: "AIå°ˆé¡Œ",
      language: "en",
      priority: 2
    },
    { 
      url: "https://deepmind.google/blog/feed.xml", 
      name: "Google DeepMind",
      country: "US",
      type: "AIå°ˆé¡Œ",
      language: "en",
      priority: 2
    },
    { 
      url: "https://ai.meta.com/blog/rss/", 
      name: "Meta AI",
      country: "US",
      type: "AIå°ˆé¡Œ",
      language: "en",
      priority: 2
    },
    { 
      url: "https://blogs.microsoft.com/ai/feed/", 
      name: "Microsoft AI",
      country: "US",
      type: "AIå°ˆé¡Œ",
      language: "en",
      priority: 2
    },
    { 
      url: "https://www.anthropic.com/blog/rss", 
      name: "Anthropic AI",
      country: "US",
      type: "AIå°ˆé¡Œ",
      language: "en",
      priority: 2
    },
    { 
      url: "https://aws.amazon.com/blogs/machine-learning/feed/", 
      name: "AWS AI/ML",
      country: "US",
      type: "AIå°ˆé¡Œ",
      language: "en",
      priority: 2
    },
    { 
      url: "https://ai.googleblog.com/feeds/posts/default", 
      name: "Google AI",
      country: "US",
      type: "AIå°ˆé¡Œ",
      language: "en",
      priority: 2
    },
    
    // ========== å°ç£æ–°è (3å€‹) ==========
    { 
      url: "https://www.cna.com.tw/rss/allnews.rss", 
      name: "ä¸­å¤®ç¤¾",
      country: "TW",
      type: "å°ç£",
      language: "zh",
      priority: 3
    },
    { 
      url: "https://feeds.feedburner.com/ettoday/realtime", 
      name: "ETtoday",
      country: "TW",
      type: "å°ç£",
      language: "zh",
      priority: 3
    },
    { 
      url: "https://news.ltn.com.tw/rss/technology.xml", 
      name: "è‡ªç”±æ™‚å ±ç§‘æŠ€",
      country: "TW",
      type: "å°ç£",
      language: "zh",
      priority: 3
    }
  ],
  
  // æ–°èæ•¸é‡è¨­å®š
  MAX_NEWS_PER_SOURCE: 10,
  TARGET_TOTAL_NEWS: 80,
  MIN_TECH_NEWS: 40,
  MAX_SUMMARY_LENGTH: 200,
  
  // åˆ†é¡è¨­å®šï¼ˆå¿…é ˆèˆ‡å‰ç«¯ä¸€è‡´ï¼‰
  CATEGORIES: {
    "AIè³‡è¨Š": ["AI", "äººå·¥æ™ºæ…§", "æ©Ÿå™¨å­¸ç¿’", "æ·±åº¦å­¸ç¿’", "ç¥ç¶“ç¶²çµ¡", "ç”Ÿæˆå¼AI", "ChatGPT", "OpenAI", "GPT", "LLM", "å¤§èªè¨€æ¨¡å‹"],
    "ç§‘æŠ€ç™¼å±•": ["ç§‘æŠ€", "æŠ€è¡“", "å‰µæ–°", "ç ”ç™¼", "ç§‘å­¸", "çªç ´", "æ–°æŠ€è¡“", "ç§‘æŠ€è¶¨å‹¢", "æ•¸ä½è½‰å‹", "å…ƒå®‡å®™", "VR", "AR", "ç‰©è¯ç¶²"],
    "è²¡ç¶“å¸‚å ´": ["è²¡ç¶“", "ç¶“æ¿Ÿ", "é‡‘è", "è‚¡å¸‚", "æŠ•è³‡", "å¸‚å ´", "å‰µæ¥­", "IPO", "ä½µè³¼", "è²¨å¹£", "åˆ©ç‡", "åŒ¯ç‡", "éŠ€è¡Œ"],
    "åœ‹éš›å¤§äº‹": ["åœ‹éš›", "å…¨çƒ", "å¤–äº¤", "æ”¿æ²»", "æ”¿ç­–", "åœ‹éš›é—œä¿‚", "åœ°ç·£æ”¿æ²»", "å…¨çƒç¶“æ¿Ÿ", "è¯åˆåœ‹"],
    "è»Ÿé«”æ‡‰ç”¨": ["è»Ÿé«”", "æ‡‰ç”¨", "App", "ç¨‹å¼", "é–‹ç™¼", "API", "ç³»çµ±", "å¹³å°", "è§£æ±ºæ–¹æ¡ˆ", "é–‹æº"],
    "ç¡¬é«”è¨­å‚™": ["ç¡¬é«”", "è¨­å‚™", "æ™¶ç‰‡", "è™•ç†å™¨", "GPU", "ä¼ºæœå™¨", "è³‡æ–™ä¸­å¿ƒ", "é‡å­é›»è…¦", "åŠå°é«”"],
    "æ–°å‰µå‹•æ…‹": ["æ–°å‰µ", "å‰µæ¥­", "Startup", "èè³‡", "å­µåŒ–å™¨", "åŠ é€Ÿå™¨", "é¢¨éšªæŠ•è³‡", "å‰µæŠ•", "å¤©ä½¿æŠ•è³‡"]
  },
  
  // å¿«å–è¨­å®š
  CACHE_DURATION: 300,
  REQUEST_TIMEOUT: 15000,
  
  VERSION: "4.0.0"
};

// ==================== å¿«å–ç®¡ç† ====================
const CacheManager = {
  getCache: function() {
    return CacheService.getScriptCache();
  },
  
  get: function(key) {
    try {
      const cache = this.getCache();
      const cached = cache.get(key);
      return cached ? JSON.parse(cached) : null;
    } catch (e) {
      console.warn("å¿«å–è®€å–å¤±æ•—:", e.message);
      return null;
    }
  },
  
  put: function(key, data, expiration = CONFIG.CACHE_DURATION) {
    try {
      const cache = this.getCache();
      cache.put(key, JSON.stringify(data), expiration);
      return true;
    } catch (e) {
      console.warn("å¿«å–å„²å­˜å¤±æ•—:", e.message);
      return false;
    }
  },
  
  remove: function(key) {
    try {
      const cache = this.getCache();
      cache.remove(key);
      return true;
    } catch (e) {
      return false;
    }
  }
};

// ==================== ä¸»è¦å‡½å¼ ====================

/**
 * Web App å…¥å£é» (GET)
 */
function doGet(e) {
  return handleRequest(e);
}

/**
 * Web App å…¥å£é» (POST)
 */
function doPost(e) {
  return handleRequest(e);
}

/**
 * è™•ç†æ‰€æœ‰è«‹æ±‚
 */
function handleRequest(e) {
  try {
    const params = e.parameter || {};
    const action = params.action || "getNews";
    const category = params.category || "all";
    
    console.log(`ğŸ“¨ æ”¶åˆ°è«‹æ±‚ - å‹•ä½œ: ${action}, åˆ†é¡: ${category}`);
    
    let responseData;
    
    switch (action) {
      case "getNews":
        responseData = getNewsData(params);
        break;
      case "getByCategory":
        responseData = getNewsByCategory(category);
        break;
      case "getTechNews":
        responseData = getTechNews();
        break;
      case "getAINews":
        responseData = getAINews();
        break;
      case "getFinanceNews":
        responseData = getFinanceNews();
        break;
      case "getInternationalNews":
        responseData = getInternationalNews();
        break;
      case "test":
        responseData = testConnection();
        break;
      case "stats":
        responseData = getStatistics();
        break;
      case "health":
        responseData = healthCheck();
        break;
      case "clearCache":
        responseData = clearCache();
        break;
      case "updateNow":
        responseData = forceUpdate();
        break;
      default:
        responseData = getNewsData(params);
    }
    
    // æ­£ç¢ºå»ºç«‹ JSON å›æ‡‰
    const output = ContentService.createTextOutput(JSON.stringify(responseData));
    output.setMimeType(ContentService.MimeType.JSON);
    
    return output;
    
  } catch (error) {
    console.error("âŒ è«‹æ±‚è™•ç†éŒ¯èª¤:", error);
    
    const errorResponse = {
      success: false,
      error: error.toString(),
      timestamp: new Date().toISOString(),
      help: "è«‹æª¢æŸ¥æ—¥èªŒæˆ–è¯çµ¡ç®¡ç†å“¡"
    };
    
    const output = ContentService.createTextOutput(JSON.stringify(errorResponse));
    output.setMimeType(ContentService.MimeType.JSON);
    
    return output;
  }
}

/**
 * å–å¾—æ–°èè³‡æ–™ (ä¸»åŠŸèƒ½)
 */
function getNewsData(params = {}) {
  const cacheKey = 'news_data_v4';
  const useCache = params.force !== 'true';
  
  // æª¢æŸ¥å¿«å–
  if (useCache) {
    const cachedData = CacheManager.get(cacheKey);
    if (cachedData) {
      console.log("ğŸ“¦ ä½¿ç”¨å¿«å–è³‡æ–™");
      cachedData.metadata.cached = true;
      cachedData.metadata.cacheTime = new Date().toISOString();
      return cachedData;
    }
  }
  
  console.log("ğŸš€ é–‹å§‹æŠ“å–æ–°èè³‡æ–™...");
  const startTime = new Date().getTime();
  
  let allNews = [];
  
  try {
    // æŠ“å–æ‰€æœ‰æ–°è
    allNews = fetchAllRSS();
    console.log(`âœ… æˆåŠŸæŠ“å– ${allNews.length} å‰‡çœŸå¯¦æ–°è`);
    
    // ç¢ºä¿ç§‘æŠ€é¡æ–°èæ•¸é‡
    const techNews = allNews.filter(news => isTechNews(news));
    if (techNews.length < CONFIG.MIN_TECH_NEWS) {
      const needed = CONFIG.MIN_TECH_NEWS - techNews.length;
      console.log(`ğŸ“Š ç§‘æŠ€é¡æ–°èä¸è¶³ï¼Œè£œå…… ${needed} å‰‡æ¨¡æ“¬ç§‘æŠ€æ–°è`);
      const mockTechNews = generateMockTechNews(needed);
      allNews = [...allNews, ...mockTechNews];
    }
    
    // ç¢ºä¿ç¸½æ•¸é‡
    if (allNews.length < CONFIG.TARGET_TOTAL_NEWS) {
      const needed = CONFIG.TARGET_TOTAL_NEWS - allNews.length;
      console.log(`ğŸ“Š ç¸½æ–°èæ•¸ä¸è¶³ï¼Œè£œå…… ${needed} å‰‡æ¨¡æ“¬æ–°è`);
      const mockNews = generateMockNews(needed);
      allNews = [...allNews, ...mockNews];
    }
    
    // é™åˆ¶ç¸½æ•¸
    allNews = allNews.slice(0, CONFIG.TARGET_TOTAL_NEWS);
    
    // åˆ†æåˆ†é¡
    allNews = analyzeCategories(allNews);
    
  } catch (error) {
    console.error("âŒ æŠ“å–å¤±æ•—:", error);
    // å¦‚æœæŠ“å–å¤±æ•—ï¼Œç”Ÿæˆæ¨¡æ“¬è³‡æ–™
    console.log("ğŸ­ ç”Ÿæˆæ¨¡æ“¬è³‡æ–™");
    allNews = generateMockNews(CONFIG.TARGET_TOTAL_NEWS);
    allNews = analyzeCategories(allNews);
  }
  
  const executionTime = new Date().getTime() - startTime;
  
  // è¨ˆç®—çµ±è¨ˆ
  const stats = calculateAdvancedStatistics(allNews);
  
  const response = {
    success: true,
    data: {
      news: allNews,
      statistics: stats,
      categories: Object.keys(CONFIG.CATEGORIES),
      systemInfo: {
        version: CONFIG.VERSION,
        lastUpdated: new Date().toISOString(),
        totalNews: allNews.length,
        techNews: allNews.filter(n => n.mainCategory === "ç§‘æŠ€ç™¼å±•" || n.mainCategory === "AIè³‡è¨Š").length,
        aiNews: allNews.filter(n => n.mainCategory === "AIè³‡è¨Š").length,
        financeNews: allNews.filter(n => n.mainCategory === "è²¡ç¶“å¸‚å ´").length,
        realNews: allNews.filter(n => n.isReal).length,
        mockNews: allNews.filter(n => !n.isReal).length
      }
    },
    metadata: {
      timestamp: new Date().toISOString(),
      executionTime: executionTime,
      sourceCount: CONFIG.RSS_SOURCES.length,
      targetNews: CONFIG.TARGET_TOTAL_NEWS,
      cacheKey: cacheKey
    }
  };
  
  // å„²å­˜åˆ°å¿«å–
  CacheManager.put(cacheKey, response);
  
  console.log(`ğŸ‰ è™•ç†å®Œæˆ: ${allNews.length} å‰‡æ–°è (${stats.byMainCategory["AIè³‡è¨Š"] || 0} AI, ${stats.byMainCategory["ç§‘æŠ€ç™¼å±•"] || 0} ç§‘æŠ€)`);
  
  return response;
}

/**
 * æŠ“å–æ‰€æœ‰RSSæ–°è
 */
function fetchAllRSS() {
  console.log("ğŸŒ é–‹å§‹æŠ“å– 22 å€‹æ–°èæº...");
  
  const allNews = [];
  
  CONFIG.RSS_SOURCES.forEach((source, index) => {
    try {
      console.log(`[${index + 1}/${CONFIG.RSS_SOURCES.length}] ${source.name} (${source.type})`);
      
      const options = {
        muteHttpExceptions: true,
        timeout: CONFIG.REQUEST_TIMEOUT
      };
      
      // ç™¼é€è«‹æ±‚
      const response = UrlFetchApp.fetch(source.url, options);
      const statusCode = response.getResponseCode();
      
      if (statusCode !== 200) {
        console.warn(`   ç‹€æ…‹ç¢¼ ${statusCode}`);
        return;
      }
      
      // è§£æ XML
      const xmlContent = response.getContentText();
      const document = XmlService.parse(xmlContent);
      const root = document.getRootElement();
      const channel = root.getChild("channel");
      
      if (!channel) {
        console.warn("   ç„¡æ•ˆçš„ RSS æ ¼å¼");
        return;
      }
      
      // å–å¾—æ–°èé …ç›®
      const items = channel.getChildren("item").slice(0, CONFIG.MAX_NEWS_PER_SOURCE);
      console.log(`   æŠ“åˆ° ${items.length} å‰‡`);
      
      items.forEach((item, itemIndex) => {
        try {
          const title = item.getChildText("title") || "ç„¡æ¨™é¡Œ";
          const link = item.getChildText("link") || "";
          const description = item.getChildText("description") || "";
          const pubDate = item.getChildText("pubDate") || new Date().toISOString();
          
          if (!title || title.trim() === "" || title === "ç„¡æ¨™é¡Œ") return;
          
          const newsItem = {
            id: `${source.name}_${Date.now()}_${itemIndex}`,
            title: cleanText(title),
            link: link.trim(),
            description: cleanText(description),
            summary: createSummary(description),
            source: source.name,
            sourceType: source.type,
            country: source.country,
            language: source.language,
            date: pubDate,
            timestamp: new Date().toISOString(),
            isReal: true
          };
          
          allNews.push(newsItem);
          
        } catch (itemError) {
          console.warn(`   è™•ç†æ–°èå¤±æ•—: ${itemError.message}`);
        }
      });
      
    } catch (sourceError) {
      console.error(`   âŒ ${source.name}: ${sourceError.message}`);
    }
  });
  
  console.log(`âœ… ç¸½å…±æŠ“åˆ° ${allNews.length} å‰‡çœŸå¯¦æ–°è`);
  return allNews;
}

/**
 * åˆ¤æ–·æ˜¯å¦ç‚ºç§‘æŠ€æ–°è
 */
function isTechNews(news) {
  const text = (news.title + " " + news.summary).toLowerCase();
  const techKeywords = [...CONFIG.CATEGORIES["AIè³‡è¨Š"], ...CONFIG.CATEGORIES["ç§‘æŠ€ç™¼å±•"]];
  return techKeywords.some(keyword => text.includes(keyword.toLowerCase()));
}

/**
 * åˆ†ææ–°èåˆ†é¡
 */
function analyzeCategories(news) {
  return news.map(item => {
    const text = (item.title + " " + item.summary + " " + item.description).toLowerCase();
    
    // ä¸»è¦åˆ†é¡åˆ¤æ–·
    let mainCategory = "å…¶ä»–";
    let categories = [];
    
    // æª¢æŸ¥æ¯å€‹åˆ†é¡çš„é—œéµå­—
    Object.entries(CONFIG.CATEGORIES).forEach(([category, keywords]) => {
      for (const keyword of keywords) {
        if (text.includes(keyword.toLowerCase())) {
          if (mainCategory === "å…¶ä»–") {
            mainCategory = category;
          }
          categories.push(category);
          break; // æ‰¾åˆ°ä¸€å€‹é—œéµå­—å°±è¶³å¤ 
        }
      }
    });
    
    // å¦‚æœæ²’æœ‰åŒ¹é…ï¼Œæ ¹æ“šä¾†æºé¡å‹åˆ¤æ–·
    if (mainCategory === "å…¶ä»–") {
      if (item.sourceType === "AIå°ˆé¡Œ") {
        mainCategory = "AIè³‡è¨Š";
      } else if (item.source.includes("Tech") || item.sourceType === "åœ‹éš›") {
        mainCategory = "ç§‘æŠ€ç™¼å±•";
      } else if (item.source.includes("Bloomberg") || item.source.includes("Financial")) {
        mainCategory = "è²¡ç¶“å¸‚å ´";
      }
    }
    
    // ç§»é™¤é‡è¤‡åˆ†é¡
    categories = [...new Set(categories)];
    if (categories.length === 0) categories.push(mainCategory);
    
    return {
      ...item,
      mainCategory: mainCategory,
      categories: categories,
      isTechNews: mainCategory === "AIè³‡è¨Š" || mainCategory === "ç§‘æŠ€ç™¼å±•",
      isAINews: mainCategory === "AIè³‡è¨Š",
      isFinanceNews: mainCategory === "è²¡ç¶“å¸‚å ´",
      isInternational: item.country !== "TW" || mainCategory === "åœ‹éš›å¤§äº‹"
    };
  });
}

/**
 * ç”Ÿæˆæ¨¡æ“¬ç§‘æŠ€æ–°è
 */
function generateMockTechNews(count) {
  console.log(`ğŸ­ ç”Ÿæˆ ${count} å‰‡æ¨¡æ“¬ç§‘æŠ€æ–°è`);
  
  const mockNews = [];
  const aiTopics = [
    "OpenAIç™¼å¸ƒGPT-5é è¦½ç‰ˆ", "Google DeepMindçªç ´æ€§ç ”ç©¶", "Microsoft Copilotæ•´åˆOffice", 
    "Metaé–‹æºLlama 3æ¨¡å‹", "ç”Ÿæˆå¼AIæ”¹è®Šå‰µä½œæ–¹å¼", "AIé†«ç™‚è¨ºæ–·æº–ç¢ºç‡é”95%",
    "ChatGPTä¼æ¥­ç‰ˆæ–°å¢åŠŸèƒ½", "AIæ™¶ç‰‡æ•ˆèƒ½æå‡300%", "æ©Ÿå™¨å­¸ç¿’è‡ªå‹•åŒ–ç¨‹å¼é–‹ç™¼",
    "AIè—è¡“å‰µä½œç²åœ‹éš›å¤§ç", "èªéŸ³AIåŠ©æ‰‹æ›´åŠ æ™ºèƒ½åŒ–", "é›»è…¦è¦–è¦ºæŠ€è¡“æ–°çªç ´"
  ];
  
  const techTopics = [
    "é‡å­é›»è…¦é‹ç®—æ–°ç´€éŒ„", "5Gç¶²è·¯å…¨é¢è¦†è“‹åŸå¸‚", "å…ƒå®‡å®™å¹³å°ç”¨æˆ¶ç ´å„„",
    "å€å¡ŠéˆæŠ€è¡“é‡‘èæ‡‰ç”¨", "é›²ç«¯é‹ç®—æˆæœ¬é™ä½40%", "ç‰©è¯ç¶²è¨­å‚™å®‰å…¨å‡ç´š",
    "è¡›æ˜Ÿé€šè¨Šå…¨çƒè¦†è“‹", "æ–°èƒ½æºæŠ€è¡“æ•ˆç‡æå‡", "ç”Ÿç‰©ç§‘æŠ€é‡å¤§çªç ´",
    "å¤ªç©ºæ¢ç´¢æ–°é‡Œç¨‹ç¢‘", "æ™ºæ…§åŸå¸‚è§£æ±ºæ–¹æ¡ˆ", "é‚Šç·£è¨ˆç®—æ‡‰ç”¨æ“´å±•"
  ];
  
  for (let i = 0; i < count; i++) {
    const isAI = Math.random() > 0.4; // 60% AIæ–°è
    const topics = isAI ? aiTopics : techTopics;
    const topic = topics[Math.floor(Math.random() * topics.length)];
    const category = isAI ? "AIè³‡è¨Š" : "ç§‘æŠ€ç™¼å±•";
    const sources = isAI ? ["OpenAI Blog", "Google AI", "Microsoft AI"] : ["TechCrunch", "Wired", "BBC Technology"];
    const source = sources[Math.floor(Math.random() * sources.length)];
    
    mockNews.push({
      id: `mock_tech_${Date.now()}_${i}`,
      title: `${topic}`,
      link: `#mock_tech_${i}`,
      description: `é€™æ˜¯ä¸€å‰‡é—œæ–¼${topic}çš„æ¨¡æ“¬æ–°èã€‚${isAI ? 'äººå·¥æ™ºæ…§é ˜åŸŸ' : 'ç§‘æŠ€ç”¢æ¥­'}çš„æœ€æ–°é€²å±•èˆ‡æ‡‰ç”¨å‰æ™¯åˆ†æã€‚`,
      summary: `${topic}çš„æœ€æ–°ç™¼å±•å ±å‘Šï¼Œåˆ†ææŠ€è¡“çªç ´ã€å¸‚å ´æ‡‰ç”¨èˆ‡æœªä¾†è¶¨å‹¢ã€‚`,
      source: source,
      sourceType: isAI ? "AIå°ˆé¡Œ" : "åœ‹éš›",
      country: "US",
      language: "zh",
      date: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
      timestamp: new Date().toISOString(),
      mainCategory: category,
      categories: [category],
      isReal: false
    });
  }
  
  return mockNews;
}

/**
 * ç”Ÿæˆæ¨¡æ“¬æ–°è
 */
function generateMockNews(count) {
  console.log(`ğŸ­ ç”Ÿæˆ ${count} å‰‡æ¨¡æ“¬æ–°è`);
  
  const mockNews = [];
  const categories = Object.keys(CONFIG.CATEGORIES);
  const sources = ["BBC Technology", "CNN Technology", "Reuters Technology", "TechCrunch", "ä¸­å¤®ç¤¾", "ETtoday", "è‡ªç”±æ™‚å ±ç§‘æŠ€"];
  
  const categoryTopics = {
    "AIè³‡è¨Š": [
      "AIæ¨¡å‹è¨“ç·´æˆæœ¬å¤§å¹…é™ä½", "ç”Ÿæˆå¼AIå‰µä½œå…§å®¹çˆ­è­°", "æ©Ÿå™¨å­¸ç¿’è‡ªå‹•åŒ–æµç¨‹",
      "ç¥ç¶“ç¶²è·¯æ¶æ§‹æ–°çªç ´", "AIå€«ç†èˆ‡æ³•è¦è¨è«–", "æ™ºèƒ½åŠ©ç†åŠŸèƒ½å‡ç´š"
    ],
    "ç§‘æŠ€ç™¼å±•": [
      "æ–°ä¸–ä»£è™•ç†å™¨ç™¼å¸ƒ", "è»Ÿç¡¬é«”æ•´åˆè¶¨å‹¢", "ç§‘æŠ€å·¨é ­ç ”ç™¼æŠ•å…¥",
      "æŠ€è¡“æ¨™æº–åˆ¶å®šé€²å±•", "å‰µæ–°ç§‘æŠ€å±•ç¤ºæœƒ", "ç ”ç™¼ç¶“è²»å¢é•·åˆ†æ"
    ],
    "è²¡ç¶“å¸‚å ´": [
      "ç§‘æŠ€è‚¡è¡¨ç¾å¼·å‹", "æ–°å‰µå…¬å¸å‹Ÿè³‡æˆåŠŸ", "å¸‚å ´æŠ•è³‡è¶¨å‹¢åˆ†æ",
      "ç¶“æ¿Ÿæ”¿ç­–å½±éŸ¿è©•ä¼°", "é‡‘èç§‘æŠ€æ‡‰ç”¨æ“´å±•", "åœ‹éš›è²¿æ˜“åˆä½œå”è­°"
    ],
    "åœ‹éš›å¤§äº‹": [
      "åœ‹éš›ç§‘æŠ€åˆä½œå”è­°", "å…¨çƒæ•¸ä½æ”¿ç­–æœƒè­°", "è·¨åœ‹ä¼æ¥­æŠ•è³‡è¨ˆåŠƒ",
      "åœ‹éš›æ¨™æº–åˆ¶å®šè¨è«–", "å…¨çƒä¾›æ‡‰éˆé‡çµ„", "åœ‹éš›ç ”ç™¼ä¸­å¿ƒè¨­ç«‹"
    ],
    "è»Ÿé«”æ‡‰ç”¨": [
      "é–‹æºå°ˆæ¡ˆæ–°ç‰ˆæœ¬ç™¼å¸ƒ", "é–‹ç™¼å·¥å…·æ•ˆèƒ½å„ªåŒ–", "è»Ÿé«”å®‰å…¨æ¼æ´ä¿®å¾©",
      "APIæœå‹™æ“´å±•åŠŸèƒ½", "é›²ç«¯å¹³å°æ›´æ–°", "ç§»å‹•æ‡‰ç”¨å‰µæ–°åŠŸèƒ½"
    ],
    "ç¡¬é«”è¨­å‚™": [
      "æ–°æ™¶ç‰‡è¨­è¨ˆæ¶æ§‹", "è£½é€ å·¥è—æŠ€è¡“çªç ´", "è¨­å‚™ä¾›æ‡‰éˆæ”¹å–„",
      "ç¡¬é«”æ•ˆèƒ½æ¸¬è©¦çµæœ", "ç”Ÿç”¢æˆæœ¬å„ªåŒ–", "ç¡¬é«”ç”Ÿæ…‹ç³»çµ±ç™¼å±•"
    ],
    "æ–°å‰µå‹•æ…‹": [
      "æ–°å‰µå…¬å¸ç”¢å“ç™¼å¸ƒ", "å‰µæŠ•åŸºé‡‘æŠ•è³‡æ–¹å‘", "å­µåŒ–å™¨æˆæœå±•ç¤º",
      "å‰µæ¥­æ¯”è³½ç²çåœ˜éšŠ", "æ–°èˆˆå¸‚å ´æ©Ÿæœƒåˆ†æ", "å‰µæ¥­ç’°å¢ƒæ”¿ç­–æ”¯æŒ"
    ]
  };
  
  for (let i = 0; i < count; i++) {
    const category = categories[Math.floor(Math.random() * categories.length)];
    const source = sources[Math.floor(Math.random() * sources.length)];
    const topics = categoryTopics[category] || ["æœ€æ–°ç™¼å±•èˆ‡è¶¨å‹¢åˆ†æ"];
    const topic = topics[Math.floor(Math.random() * topics.length)];
    
    mockNews.push({
      id: `mock_${Date.now()}_${i}`,
      title: `[${category}] ${topic}`,
      link: `#mock_${i}`,
      description: `é€™æ˜¯ä¸€å‰‡é—œæ–¼${category}çš„æ¨¡æ“¬æ–°èï¼Œä¸»é¡Œç‚º${topic}ã€‚å…§å®¹åŒ…å«å°ˆæ¥­åˆ†æã€å¸‚å ´è¶¨å‹¢èˆ‡æœªä¾†å±•æœ›ã€‚`,
      summary: `${category}é ˜åŸŸçš„æœ€æ–°ç™¼å±•ï¼š${topic}ã€‚`,
      source: source,
      sourceType: source.includes("ä¸­å¤®ç¤¾") || source.includes("ETtoday") || source.includes("è‡ªç”±æ™‚å ±") ? "å°ç£" : "åœ‹éš›",
      country: source.includes("ä¸­å¤®ç¤¾") || source.includes("ETtoday") || source.includes("è‡ªç”±æ™‚å ±") ? "TW" : "US",
      language: source.includes("ä¸­å¤®ç¤¾") || source.includes("ETtoday") || source.includes("è‡ªç”±æ™‚å ±") ? "zh" : "en",
      date: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
      timestamp: new Date().toISOString(),
      mainCategory: category,
      categories: [category],
      isReal: false
    });
  }
  
  return mockNews;
}

/**
 * è¨ˆç®—é€²éšçµ±è¨ˆè³‡æ–™
 */
function calculateAdvancedStatistics(news) {
  const stats = {
    total: news.length,
    byMainCategory: {},
    bySourceType: {},
    byCountry: {},
    byLanguage: {},
    realNews: news.filter(n => n.isReal).length,
    mockNews: news.filter(n => !n.isReal).length,
    aiNews: news.filter(n => n.mainCategory === "AIè³‡è¨Š").length,
    techNews: news.filter(n => n.mainCategory === "ç§‘æŠ€ç™¼å±•").length,
    financeNews: news.filter(n => n.mainCategory === "è²¡ç¶“å¸‚å ´").length
  };
  
  news.forEach(item => {
    // ä¸»åˆ†é¡çµ±è¨ˆ
    stats.byMainCategory[item.mainCategory] = (stats.byMainCategory[item.mainCategory] || 0) + 1;
    
    // ä¾†æºé¡å‹çµ±è¨ˆ
    stats.bySourceType[item.sourceType] = (stats.bySourceType[item.sourceType] || 0) + 1;
    
    // åœ‹å®¶çµ±è¨ˆ
    stats.byCountry[item.country] = (stats.byCountry[item.country] || 0) + 1;
    
    // èªè¨€çµ±è¨ˆ
    stats.byLanguage[item.language] = (stats.byLanguage[item.language] || 0) + 1;
  });
  
  // è¨ˆç®—ç™¾åˆ†æ¯”
  stats.mockPercentage = Math.round((stats.mockNews / stats.total) * 100);
  stats.aiPercentage = Math.round((stats.aiNews / stats.total) * 100);
  stats.techPercentage = Math.round((stats.techNews / stats.total) * 100);
  stats.financePercentage = Math.round((stats.financeNews / stats.total) * 100);
  
  return stats;
}

// ==================== åˆ†é¡APIç«¯é» ====================

function getNewsByCategory(category) {
  const allData = getNewsData();
  if (!allData.success) return allData;
  
  let filteredNews;
  if (category === "all") {
    filteredNews = allData.data.news;
  } else {
    filteredNews = allData.data.news.filter(item => 
      item.mainCategory === category || item.categories.includes(category)
    );
  }
  
  return {
    success: true,
    data: {
      news: filteredNews,
      category: category,
      count: filteredNews.length
    },
    metadata: {
      timestamp: new Date().toISOString(),
      totalCategories: Object.keys(CONFIG.CATEGORIES).length
    }
  };
}

function getTechNews() {
  const allData = getNewsData();
  if (!allData.success) return allData;
  
  const techNews = allData.data.news.filter(item => 
    item.mainCategory === "AIè³‡è¨Š" || item.mainCategory === "ç§‘æŠ€ç™¼å±•"
  );
  
  return {
    success: true,
    data: {
      news: techNews,
      category: "ç§‘æŠ€é¡",
      count: techNews.length,
      subCounts: {
        ai: techNews.filter(n => n.mainCategory === "AIè³‡è¨Š").length,
        tech: techNews.filter(n => n.mainCategory === "ç§‘æŠ€ç™¼å±•").length
      }
    }
  };
}

function getAINews() {
  const allData = getNewsData();
  if (!allData.success) return allData;
  
  const aiNews = allData.data.news.filter(item => item.mainCategory === "AIè³‡è¨Š");
  
  return {
    success: true,
    data: {
      news: aiNews,
      category: "AIè³‡è¨Š",
      count: aiNews.length
    }
  };
}

function getFinanceNews() {
  const allData = getNewsData();
  if (!allData.success) return allData;
  
  const financeNews = allData.data.news.filter(item => 
    item.mainCategory === "è²¡ç¶“å¸‚å ´" || item.categories.includes("è²¡ç¶“å¸‚å ´")
  );
  
  return {
    success: true,
    data: {
      news: financeNews,
      category: "è²¡ç¶“å¸‚å ´",
      count: financeNews.length
    }
  };
}

function getInternationalNews() {
  const allData = getNewsData();
  if (!allData.success) return allData;
  
  const intlNews = allData.data.news.filter(item => 
    item.country !== "TW" || item.mainCategory === "åœ‹éš›å¤§äº‹"
  );
  
  return {
    success: true,
    data: {
      news: intlNews,
      category: "åœ‹éš›æ–°è",
      count: intlNews.length
    }
  };
}

// ==================== å·¥å…·å‡½å¼ ====================

function testConnection() {
  return {
    success: true,
    message: "å…¨çƒAIç§‘æŠ€æ–°èç³»çµ± API æ­£å¸¸é‹ä½œä¸­",
    version: CONFIG.VERSION,
    timestamp: new Date().toISOString(),
    config: {
      totalSources: CONFIG.RSS_SOURCES.length,
      targetNews: CONFIG.TARGET_TOTAL_NEWS,
      minTechNews: CONFIG.MIN_TECH_NEWS,
      categories: Object.keys(CONFIG.CATEGORIES)
    },
    endpoints: {
      getNews: "?action=getNews",
      getTechNews: "?action=getTechNews",
      getAINews: "?action=getAINews",
      test: "?action=test",
      stats: "?action=stats"
    }
  };
}

function getStatistics() {
  try {
    return {
      success: true,
      statistics: {
        totalSources: CONFIG.RSS_SOURCES.length,
        categories: Object.keys(CONFIG.CATEGORIES),
        targetNews: CONFIG.TARGET_TOTAL_NEWS,
        minTechNews: CONFIG.MIN_TECH_NEWS,
        lastUpdated: new Date().toISOString()
      }
    };
  } catch (error) {
    return {
      success: false,
      error: error.toString()
    };
  }
}

function healthCheck() {
  return {
    success: true,
    health: {
      rss_sources: CONFIG.RSS_SOURCES.length,
      script_running: true,
      timestamp: new Date().toISOString()
    },
    version: CONFIG.VERSION
  };
}

function clearCache() {
  try {
    CacheManager.remove('news_data_v4');
    return {
      success: true,
      message: "å¿«å–å·²æ¸…é™¤",
      timestamp: new Date().toISOString()
    };
  } catch (error) {
    return {
      success: false,
      error: error.toString()
    };
  }
}

function forceUpdate() {
  try {
    const result = getNewsData({ force: true });
    return {
      success: true,
      message: "å¼·åˆ¶æ›´æ–°å®Œæˆ",
      newsCount: result.data ? result.data.news.length : 0,
      timestamp: new Date().toISOString()
    };
  } catch (error) {
    return {
      success: false,
      error: error.toString()
    };
  }
}

function createSummary(text) {
  if (!text || text.trim() === "") {
    return "ç„¡æ‘˜è¦å…§å®¹";
  }
  
  let cleanText = text.replace(/<[^>]+>/g, "");
  cleanText = cleanText.replace(/\s+/g, " ").trim();
  
  if (cleanText.length <= CONFIG.MAX_SUMMARY_LENGTH) {
    return cleanText;
  }
  
  return cleanText.substring(0, CONFIG.MAX_SUMMARY_LENGTH) + "...";
}

function cleanText(text) {
  if (!text) return "";
  return text.replace(/\s+/g, " ").trim();
}

// ==================== ç®¡ç†å‡½å¼ ====================

function onOpen() {
  try {
    const ui = SpreadsheetApp.getUi();
    ui.createMenu('ğŸ¤– AIæ–°èç³»çµ±')
      .addItem('ğŸ”„ æ›´æ–°æ–°è', 'manualUpdate')
      .addItem('ğŸ“Š æª¢è¦–çµ±è¨ˆ', 'showStatistics')
      .addItem('âš™ï¸ ç³»çµ±è¨­å®š', 'showSystemInfo')
      .addToUi();
  } catch (e) {
    console.log("ç„¡æ³•å»ºç«‹é¸å–®");
  }
}

function manualUpdate() {
  try {
    const result = getNewsData({ force: true });
    SpreadsheetApp.getActiveSpreadsheet().toast(
      `å·²æ›´æ–° ${result.data.news.length} å‰‡æ–°è`,
      'æ›´æ–°å®Œæˆ',
      5
    );
  } catch (error) {
    SpreadsheetApp.getActiveSpreadsheet().toast(
      `æ›´æ–°å¤±æ•—: ${error.message}`,
      'éŒ¯èª¤',
      5
    );
  }
}

function showStatistics() {
  const ui = SpreadsheetApp.getUi();
  ui.alert('ğŸ“Š ç³»çµ±çµ±è¨ˆ',
    `æ–°èæº: ${CONFIG.RSS_SOURCES.length} å€‹\n` +
    `ç›®æ¨™æ–°èæ•¸: ${CONFIG.TARGET_TOTAL_NEWS} å‰‡\n` +
    `æœ€å°‘ç§‘æŠ€æ–°è: ${CONFIG.MIN_TECH_NEWS} å‰‡\n` +
    `åˆ†é¡æ•¸é‡: ${Object.keys(CONFIG.CATEGORIES).length} ç¨®\n` +
    `ç‰ˆæœ¬: ${CONFIG.VERSION}`,
    ui.ButtonSet.OK);
}

function showSystemInfo() {
  const ui = SpreadsheetApp.getUi();
  ui.alert('âš™ï¸ ç³»çµ±è³‡è¨Š',
    `å…¨çƒAIç§‘æŠ€æ–°èç³»çµ± v${CONFIG.VERSION}\n` +
    `åœ‹éš›æ–°èæº: ${CONFIG.RSS_SOURCES.filter(s => s.type === "åœ‹éš›").length} å€‹\n` +
    `AIå°ˆé¡Œæº: ${CONFIG.RSS_SOURCES.filter(s => s.type === "AIå°ˆé¡Œ").length} å€‹\n` +
    `å°ç£æ–°èæº: ${CONFIG.RSS_SOURCES.filter(s => s.type === "å°ç£").length} å€‹\n` +
    `æœ€å¾Œæ›´æ–°: ${new Date().toLocaleString('zh-TW')}`,
    ui.ButtonSet.OK);
}
